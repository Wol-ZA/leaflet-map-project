<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time GPS Tracking Map with Custom Marker</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
  <style>
    /* Fullscreen map container */
    #viewDiv {
      height: 100vh;
      width: 100vw;
    }
  </style>
  <script src="https://js.arcgis.com/4.27/"></script>
</head>
<body>
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/geometry/Point",
      "esri/Graphic",
      "esri/symbols/IconSymbol3DLayer",
      "esri/symbols/PointSymbol3D"
    ], function(Map, SceneView, Point, Graphic, IconSymbol3DLayer, PointSymbol3D) {
      const map = new Map({
        basemap: "topo",
        ground: "world-elevation"
      });

      const view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: {
          position: { latitude: 0, longitude: 0, z: 10000 },
          tilt: 80
        }
      });

      // Define the custom marker symbol
      const planeSymbol = new PointSymbol3D({
        symbolLayers: [
          new IconSymbol3DLayer({
            resource: { href: "plane_1.png" },
            size: 30
          })
        ]
      });

      // Create a graphic to represent the user's position
      const planeGraphic = new Graphic({
        geometry: new Point({ latitude: 0, longitude: 0, z: 1000 }),
        symbol: planeSymbol
      });
      view.graphics.add(planeGraphic);

      function updateLocation(latitude, longitude, altitude) {
        console.log("Updating location:", latitude, longitude, altitude);

        const newLocation = new Point({
          latitude: latitude,
          longitude: longitude,
          z: altitude || 1000
        });

        // Calculate the distance between current view center and the new location
        const distance = Math.sqrt(
          Math.pow(view.center.latitude - newLocation.latitude, 2) +
          Math.pow(view.center.longitude - newLocation.longitude, 2)
        );

        // Update only if the new location is significantly different
        if (distance > 0.0010) { // Adjust this threshold as needed
          planeGraphic.geometry = newLocation;
          view.center = newLocation;
        } else {
          // Just update the graphic position without changing the view center
          planeGraphic.geometry = newLocation;
        }
      }

      if (navigator.geolocation) {
        console.log("Geolocation is supported.");

        navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude, altitude } = position.coords;
            console.log("Position received:", position.coords);
            updateLocation(latitude, longitude, altitude);
          },
          (error) => {
            console.error("Error getting location:", error);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 5000
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser.");
      }
    });
  </script>
</body>
</html>
