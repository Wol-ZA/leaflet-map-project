<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Corner Cut Radius Inside Only</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  #map{height:100vh;}
  .cut { color:red; font-weight:bold; }
</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
//--------------------------------------------------
// 1. Basic map
//--------------------------------------------------
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

let route = [], segments = [], corners = [];

//--------------------------------------------------
// 2. Utilities
//--------------------------------------------------
function bearing(from,to){
  const f=from.lat*Math.PI/180, t=to.lat*Math.PI/180,
        dLon=(to.lng-from.lng)*Math.PI/180;
  const y=Math.sin(dLon)*Math.cos(t);
  const x=Math.cos(f)*Math.sin(t)-Math.sin(f)*Math.cos(t)*Math.cos(dLon);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function sectorPoints(center,bearingStart,bearingEnd,radius,step=5){
  const pts=[center];
  const dir = ((bearingEnd - bearingStart + 360) % 360) > 180 ? -1 : 1;
  let angle=bearingStart;
  while (true) {
    pts.push(destination(center, angle, radius));
    if (Math.abs((angle - bearingEnd + 360) % 360) < step) break;
    angle = (angle + dir*step + 360) % 360;
  }
  pts.push(center);
  return pts;
}
function destination(latlng,bearing,dist){
  const R=6378137;
  const br=bearing*Math.PI/180;
  const lat1=latlng.lat*Math.PI/180;
  const lon1=latlng.lng*Math.PI/180;
  const d=dist/R;
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(br));
  const lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(lat1),
                             Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}

//--------------------------------------------------
// 3. Load route and create corner sectors
//--------------------------------------------------
fetch('route.geojson').then(r=>r.json()).then(data=>{
  route=data.features.sort((a,b)=>{
    const order={ 'Fp':0,'T1':1,'T2':2,'T3':3,'T4':4,'T5':5,'T6':6,'T7':7,'T8':8,'T9':9,'SP':10 };
    return order[a.properties.description]-order[b.properties.description];
  }).map(f=>[f.geometry.coordinates[1],f.geometry.coordinates[0]]);

  const routeLine=L.polyline(route,{color:'black',weight:3,dashArray:'6,10'}).addTo(map);
  map.fitBounds(routeLine.getBounds().pad(0.2));

  // Build segments
  for(let i=0;i<route.length-1;i++){
    const a=L.latLng(route[i]);
    const b=L.latLng(route[i+1]);
    segments.push({a,b,len:a.distanceTo(b)});
  }

  // Detect corners & draw inside sectors
  corners=data.features.filter(f=>/^T\d+$/i.test(f.properties.description))
  .map(f=>{
    const idx=route.findIndex(r=>r[0]===f.geometry.coordinates[1] &&
                                 r[1]===f.geometry.coordinates[0]);
    const prev=L.latLng(route[Math.max(0,idx-1)]);
    const next=L.latLng(route[Math.min(route.length-1,idx+1)]);
    const center=L.latLng(route[idx]);
    const b1=bearing(center,prev);
    const b2=bearing(center,next);

    // inside is roughly halfway between the two bearings
    let insideDir = (b1 + b2) / 2;
    if (Math.abs(b1 - b2) > 180) insideDir = (insideDir + 180) % 360;

    const spread=60; // half-angle of the wedge
    const radius=50; // meters

    const pts = sectorPoints([center.lat,center.lng],
                              insideDir - spread,
                              insideDir + spread,
                              radius,5);

    // Draw sector polygon
    L.polygon(pts,{
      color:'orange',
      weight:2,
      fillColor:'orange',
      fillOpacity:0.15
    }).addTo(map);

    return {point:center,radius};
  });

  loadRacers();
});

//--------------------------------------------------
// 4. Dummy racers to demonstrate
//--------------------------------------------------
function loadRacers(){
  const marker = L.circleMarker(route[0],{color:'blue'}).addTo(map);
  let i=0;
  setInterval(()=>{
    i=(i+1)%route.length;
    marker.setLatLng(route[i]);
  },1500);
}
</script>
</body>
</html>
